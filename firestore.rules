// DO NOT MODIFY THESE ON FIREBASE'S DASHBOARD.
// THESE RULES ARE CONTROLLED BY FILES IN A GIT REPOSITORY.
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // create and delete should be controlled by functions
    match /users/{userId} {
      allow read;

      allow update: if
        request.auth.uid != null &&
        request.path[4:5] == /$(request.auth.uid) &&
        request.resource.data.keys().hasAll(["name", "profileImageURL"]) &&
        request.resource.data.keys().hasOnly(["name", "profileImageURL"]) &&
        request.resource.data.name is string &&
        request.resource.data.name.size() >= 3 &&
        request.resource.data.name.size() < 32 &&
        request.resource.data.profileImageURL == resource.data.profileImageURL;
    }

    match /posts/{postId} {
      allow read;

      match /answers/{answerId} {
        allow read;

        allow create: if
          request.auth.uid != null &&
          request.resource.data.keys().hasAll(["post", "user", "body", "likes", "dislikes"]) &&
          request.resource.data.keys().hasOnly(["post", "user", "body", "likes", "dislikes"]) &&
          request.resource.data.post is path &&
          request.resource.data.post == request.path[0:5] &&
          request.resource.data.user is path &&
          request.resource.data.user[3:] == /users/$(request.auth.uid) &&
          request.resource.data.body is string &&
          request.resource.data.body.size() >= 8 &&
          request.resource.data.body.size() < 65536 &&
          request.resource.data.likes is int &&
          request.resource.data.likes == 0 &&
          request.resource.data.dislikes is int &&
          request.resource.data.dislikes == 0;

        match /comments/{commentId} {
          match /reactions/{reactionId} {
            allow list: if
              request.auth.uid != null &&
              resource.data.user[3:] == /users/$(request.auth.uid);

            allow create: if
              request.auth.uid != null &&
              request.path[10:] == /$(request.auth.uid) &&
              request.resource.data.keys().hasAll(["comment", "user", "type"]) &&
              request.resource.data.keys().hasOnly(["comment", "user", "type"]) &&
              request.resource.data.comment is path &&
              request.resource.data.comment[3:] == /posts/$(postId)/answers/$(answerId)/comments/$(commentId) &&
              exists(request.resource.data.comment) &&
              request.resource.data.user is path &&
              request.resource.data.user[3:] == /users/$(request.auth.uid) &&
              request.resource.data.type in ["LIKE", "DISLIKE"];

            allow delete: if
              request.auth.uid != null &&
              resource.data.user[3:] == /users/$(request.auth.uid);
          }
        }

        match /reactions/{reactionId} {
          allow list: if
            request.auth.uid != null &&
            resource.data.user[3:] == /users/$(request.auth.uid);

          allow create: if
            request.auth.uid != null &&
            request.path[8:] == /$(request.auth.uid) &&
            request.resource.data.keys().hasAll(["answer", "user", "type"]) &&
            request.resource.data.keys().hasOnly(["answer", "user", "type"]) &&
            request.resource.data.answer is path &&
            request.resource.data.answer[3:] == /posts/$(postId)/answers/$(answerId) &&
            exists(request.resource.data.answer) &&
            request.resource.data.user is path &&
            request.resource.data.user[3:] == /users/$(request.auth.uid) &&
            request.resource.data.type in ["LIKE", "DISLIKE"];

          allow delete: if
            request.auth.uid != null &&
            resource.data.user[3:] == /users/$(request.auth.uid);
        }
      }
    }
  }
}